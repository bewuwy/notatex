<!DOCTYPE html>
<html lang="pl">
    <head>
        <%- include('partials/head'); %>

        <script>
            function initiateLoad() {
                firebase.auth().onAuthStateChanged(function(user) {
                    if (user) {
                        // User is signed in.
                        user.getIdToken().then(function(accessToken) {
                            let p;
                            const accInf = document.getElementById("accountInfo");
                            accInf.innerHTML = "";

                            // user display name
                            p = document.createElement("p");
                            p.innerText = "Username: " + user.displayName;
                            accInf.appendChild(p);

                            // user email
                            p = document.createElement("p");
                            p.innerText = "e-mail: " + user.email;
                            accInf.appendChild(p);

                            // user account creation date
                            const date = new Date(user.metadata.creationTime);
                            const dNow = new Date();
                            let tDelta = dNow - date;

                            if (tDelta < 1000 * 60 * 60 * 24) {
                                tDelta = "today";
                            }
                            else {
                                tDelta = `${Math.round((dNow - date)/1000/60/60/24)} days ago`;
                            }

                            console.log(date);

                            p = document.createElement("p");
                            p.innerText = `Account created: ${tDelta}`;
                            accInf.appendChild(p);

                            // load saved notes
                            fetch("/api/savedNotes", {method: "POST",
                                headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
                                body: JSON.stringify({userId: user.uid})}).then(res => res.json()).then(data => {

                                    document.getElementById('savedNotes').innerHTML = "";
                                    data.forEach(e => {
                                        let a;
                                        p = document.createElement("p");

                                        a = document.createElement("a");
                                        a.innerText = e.replace(/-/g, " ");
                                        a.href = "/note/" + e;
                                        a.classList.value = "hover:underline hover:font-bold text-md";

                                        p.appendChild(a);
                                        document.getElementById('savedNotes').appendChild(p);
                                    });
                            });

                            // delete account button
                            firebase.auth().currentUser.getIdToken().then(function(idToken) {
                                document.getElementById("deleteAccount").onclick = function () {
                                    if (confirm("Are you sure you want to delete your account?") === true) {
                                        fetch("/api/deleteAccount", {method: "POST",
                                            headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
                                            body: JSON.stringify({userToken: idToken })})
                                            .then(res => res.json()).then(data => {
                                                console.log(data);

                                                alert("Your account has been deleted");
                                                window.location='/';
                                        });
                                    }
                                }
                            });
                        });
                    }
                    else {
                        // User is signed out.
                        window.location='/';
                    }
                }, function(error) {
                    console.log(error);
                });
            }
        </script>
    </head>
    <body class="bg-slate-800 text-white
                 w-10/12 md:w-1/2 mx-auto mt-12" onload="initiateLoad()">

        <div class="mb-24">
            <div class="mb-12">
                <%- include('partials/logo'); %>
            </div>

            <div class="flex flex-wrap justify-center">
                <div class="basis-full mb-12
                bg-blue-500 px-20 py-4 rounded-2xl">

                    <h2 class="text-2xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block align-text-bottom h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                        </svg>
                        Saved notes
                    </h2>
                    <!-- TODO: add real saved notes -->

                    <div id="savedNotes">
                        <p>Loading...</p>
                    </div>
                </div>

                <div class="basis-full mb-12
                bg-blue-500 px-20 py-4 rounded-2xl">

                    <h2 class="text-2xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block align-text-bottom h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2" />
                        </svg>
                        Account Info
                    </h2>

                    <div id="accountInfo">
                        <p>Loading...</p>
                    </div>
                </div>

                <button class="bg-red-500" id="deleteAccount">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block align-text-bottom h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6" />
                    </svg>
                    Delete account</button>
            </div>
        </div>
    </body>
</html>

<!DOCTYPE html>
<html lang="en">
    <head>
        <%- include('partials/head'); %>
        <script src="/javascripts/userData.js"></script>
        <script src="/javascripts/utils.js"></script>

        <script>
            function initiateLoad() {
                firebase.auth().onAuthStateChanged(function(user) {
                    if (user) {
                        // User is signed in.
                        const savedNotesDiv = document.getElementById("savedNotes");
                        const accInf = document.getElementById("accountInfo");

                        // load account info
                            accInf.innerHTML = "";

                            // user display name
                                accInf.appendChild(createParagraph("Username: " + user.displayName, user.displayName));

                            // user email
                                accInf.appendChild(createParagraph("e-mail: " + user.email, user.email));

                            // user account creation date
                                const date = new Date(user.metadata.creationTime);
                                const dNow = new Date();
                                let tDelta = dNow - date;

                                if (tDelta < 1000 * 60 * 60 * 24) {
                                    tDelta = "today";
                                }
                                else {
                                    tDelta = `${Math.round((dNow - date)/1000/60/60/24)} days ago`;
                                }

                                accInf.appendChild(createParagraph(`Account created: ${tDelta}`, user.metadata.creationTime));

                            // user id
                                const uid_ = document.createElement("span");
                                uid_.classList.add("spoiler");  // TODO: add some kind of spoiler
                                uid_.innerText = user.uid;

                                const p_ = createParagraph(`User ID: `);
                                p_.appendChild(uid_);

                                accInf.appendChild(p_);

                        // load saved notes
                            getSavedNotes(user.uid).then(res => res.json()).then(data => {
                                savedNotesDiv.innerHTML = "";

                                if (data[0]) {
                                    data.forEach(e => {
                                        let a = document.createElement("a");
                                        let p = document.createElement("p");

                                        a.innerText = e.replace(/-/g, " ");
                                        a.href = "/note/" + e;
                                        a.classList.value = "hover:underline hover:font-bold text-md";

                                        p.appendChild(a);
                                        savedNotesDiv.appendChild(p);
                                    });
                                }
                                else {
                                    savedNotesDiv.appendChild(createParagraph("No saved notes D:"));
                                }
                            });

                        // delete account button
                            document.getElementById("deleteAccount").onclick = function () {
                                firebase.auth().currentUser.getIdToken().then(function(idToken) {
                                    if (confirm("Are you sure you want to delete your account?") === true) {
                                        deleteAccount(idToken).then(res => res.json()).then(data => {
                                                console.log(data);

                                                alert("Your account has been deleted");
                                                window.location='/';
                                        });
                                    }
                                });
                            };
                    }
                    else {
                        // User is signed out.
                        window.location='/login';
                    }
                }, function(error) {
                    console.log(error);
                });
            }
        </script>
    </head>
    <body onload="initiateLoad()">
        <div id="content">

            <div class="mb-12">
                <%- include('partials/topBar'); %>
            </div>

            <div class="flex flex-wrap justify-center">
                <div class="infoElement">

                    <h2 class="text-2xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block align-text-bottom h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                        </svg>
                        Saved notes
                    </h2>
                    <div id="savedNotes">
                        <p>Loading...</p>
                    </div>
                </div>

                <div class="infoElement">

                    <h2 class="text-2xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block align-text-bottom h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2" />
                        </svg>
                        Account Info
                    </h2>

                    <div id="accountInfo">
                        <p>Loading...</p>
                    </div>
                </div>

                <button class="bg-red-500" id="deleteAccount">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block align-text-bottom h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6" />
                    </svg>
                    Delete account
                </button>
            </div>
        </div>
    </body>
</html>

<!DOCTYPE html>
<html lang="pl">
    <head>
        <%- include('partials/head', { title: title }); %>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const saveNote = document.getElementById("saveNote");
                const noteId = window.location.toString().split("note/")[1];

                firebase.auth().onAuthStateChanged(function(user) {
                   if (user) {
                       // signed in

                       // check if note already saved
                       fetch("/api/savedNotes", {method: "POST",
                           headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
                           body: JSON.stringify({userId: user.uid})}).then(res => res.json()).then(data => {

                           if (data.includes(noteId)) {
                               // note saved

                               saveNote.onclick = null;
                               saveNote.innerText = "Note saved";
                               saveNote.classList.value = "text-gray-500";
                           }
                           else {
                               // note not saved

                               saveNote.onclick = function () {
                                   // save note by id and user token
                                   firebase.auth().currentUser.getIdToken().then(function(idToken) {
                                       saveNote.innerText = "Loading...";
                                       saveNote.onclick = null;

                                       fetch("/api/saveNote", {method: "POST",
                                           headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
                                           body: JSON.stringify({userToken: idToken, note: noteId})})
                                           .then(res => res.json()).then(data => {
                                           if (data.success) {
                                               console.log(data);

                                               saveNote.innerText = "Note saved";
                                               saveNote.classList.value = "text-gray-500";
                                           }
                                       });
                                   });
                               };
                           }
                       });
                   }
                   else {
                       // signed out

                       saveNote.classList.value = "hidden";
                   }
                });
            }, false);
        </script>
    </head>
    <body class="bg-slate-800 text-white
                   w-10/12 md:w-1/2 mx-auto mt-6 md:mt-12">

        <div class="mb-16 md:mb-24">
            <div>
                <%- include('partials/logo'); %>
            </div>

            <div class="my-7 md:my-10">
                <h1 class="mb-0"><%= title %></h1>
                <a id="saveNote" class="group hover:underline hover:font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="group-hover:scale-110 inline-block align-text-bottom h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                    </svg>Save note
                </a>
            </div>

            <div id="note">
                <%- content %>
            </div>
        </div>
    </body>
</html>

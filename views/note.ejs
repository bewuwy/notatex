<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/head', { title: title }); %>
    <script src="/javascripts/userData.js"></script>

    <!-- latex support using MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$']]
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const saveNoteA = document.getElementById("saveNote");
            const saveNoteText = document.getElementById("saveNoteText");

            const noteId = window.location.toString().split("note/")[1];

            function saveNoteClick() {
                // save note by id and current user's token
                firebase.auth().currentUser.getIdToken().then(function (idToken) {
                    saveNoteText.innerText = "Loading...";
                    saveNoteA.onclick = null;

                    saveNote(noteId, idToken).then(res => res.json()).then(data => {
                        if (data.success) {
                            console.log(data);

                            saveNoteText.innerText = "Note saved";
                            saveNoteA.classList.value = "text-gray-500";

                            saveNoteA.onclick = unsaveNoteClick;
                        }
                    });
                });
            }

            function unsaveNoteClick() {
                // remove note by id and current user's token
                firebase.auth().currentUser.getIdToken().then(function (idToken) {
                    saveNoteText.innerText = "Loading...";
                    saveNoteA.onclick = null;

                    unsaveNote(noteId, idToken).then(res => res.json()).then(data => {
                        if (data.success) {
                            console.log(data);

                            saveNoteText.innerText = "Save note";
                            saveNoteA.classList.value = "group hover:underline hover:font-bold";

                            saveNoteA.onclick = saveNoteClick;
                        }
                    });
                });
            }

            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    // signed in

                    // check if note already saved
                    getSavedNotes(user.uid).then(res => res.json()).then(data => {
                        // TODO: something better to check if saved than downloading whole list of savedNotes?
                        if (data.includes(noteId)) {
                            // note saved

                            saveNoteText.innerText = "Note saved";
                            saveNoteA.classList.value = "text-gray-500";

                            saveNoteA.onclick = unsaveNoteClick;
                        } else {
                            // note not saved

                            saveNoteA.onclick = saveNoteClick;
                        }
                    });
                } else {
                    // signed out

                    saveNoteA.onclick = null;
                    saveNoteA.href = "/login";
                    saveNoteA.classList.value = "text-gray-500 italic";
                    saveNoteText.innerText = "Log in to be able to save notes and change themes";
                }
            });
        }, false);
    </script>
</head>
<body>
<!-- TODO: more themes -->
<!-- TODO: table of contents -->
<!-- TODO: share button -->

<div id="content" class="pb-16 md:pb-24">

    <div class="text-white">
        <%- include('partials/topBar'); %>
    </div>

    <div class="my-7 md:my-10">
        <h1 class="mb-2 md:mb-0"><%= title %></h1>
        <a id="saveNote" class="group hover:underline hover:font-bold">
            <svg xmlns="http://www.w3.org/2000/svg" class="group-hover:scale-110 inline-block align-text-bottom h-5 w-5"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
            </svg>
            <span id="saveNoteText">Save note</span>
        </a>
    </div>

    <div id="note">
        <%- content %>
    </div>
</div>
</body>
</html>
